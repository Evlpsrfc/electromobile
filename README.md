# 苏州大学充电桩助手

![flask](https://img.shields.io/badge/flask-2.2.x-blue)
![bootstrap](https://img.shields.io/badge/bootstrap-5.2.x-blueviolet)

## 项目背景

2018年5月5日，苏州市委、市政府部署启动了“331”专项行动，主要任务之一是聚力整治电动自行车领域突出的火灾隐患。同年，苏州大学积极响应号召，取消整改了图书馆地下室、理工楼地下室等所有室内充电场所，并招标建设一系列室外充电棚。苏州苏迪智能系统有限公司成功中标，该公司的新一代支持支付宝脱机二维码扫码的POS机和自主开发的结算管理平台一直使用至今。

随着校内使用人数的扩张，充电棚使用的频次连年递增，且由于技术上的难度，无法对充电区域实施有效的监管，恶意破坏充电设备的现象也层出不穷。再加上苏迪公司相关开发人员的离职，对于充电插座、主机的维修也变得十分缓慢。这就导致校内师生员工越来越难以找到可用的充电桩，即使成功充上也要担心是否会被拔。

对于上述问题，学校方面一直在积极地处理。一方面，将部分充电棚改为插座直充，但为了保障充电安全，晚上十点钟以后自动断电；另一方面，着手准备重新招标翻新现有充电棚，彻底更换所有充电设备。正是在这一契机下，我们有幸拿到了充电管理系统的后台地址及账号，通过对其提供的部分接口进行封装，实现了充电设备状态的实时查询，方便用户寻找可用的充电插座。

## 功能介绍

校园局域网用户访问 [http://10.20.7.127:5000](http://10.20.7.127:5000)，外网用户访问 [http://sudacharge.haoxiaoren.com/](http://sudacharge.haoxiaoren.com/)，即可查询天赐庄校区、独墅湖校区、阳澄湖校区的充电设备使用情况，包括待机、充电中、已损坏。同时，为了方便二次开发，开放接口 [http://10.20.7.127:5000/pos/getDeviceStatus](http://10.20.7.127:5000/pos/getDeviceStatus)，通过 POST 包含 `deviceNum` 和 `cdpNum` 负载的请求，即可查询到后台的原始数据。具体格式见[main.py#L120-L135](https://github.com/Evlpsrfc/electromobile/blob/main/main.py#L120-L135)。

## 实现细节

使用 Flask 搭建后端，Bootstrap 进行前端美化。从本质上来说，后端的行为很像一个中继服务器，它把用户的请求附上 session id 发送到目标后台的对应接口。其中 session id 用于保持 Flask 后端和目标后台的通讯，若发现登录失效则需要由用户重新输入验证码。为了减少用户输入验证码的次数，该 session id 在 Flask 后端中是全局共享的。

后台传来的数据是一个列表，每一项都是包含以下键值对的字典：
```
cddl: 数字组成的字符串，表示充电电量
cdgl: 数字组成的字符串，表示充电功率
cdpbh: 数字或字母组成的字符串，表示充电棚编号
czbh: 两位数字组成的字符串，表示插座编号
czzt: 一位字符串，可能取值 "0", "1", "3"，表示插座状态，分别代表待机、在充电、已离线
dqbh: 地区编号，永远为 "JSSZ", 江苏苏州
posbh: 八位数字组成的字符串，表示POS机编号
posip: POS机IP地址，目前暂时没有开发出利用方法
qdsbh: 渠道商编号，永远为 "010001"
sfzx: 布尔型，表示管理该插座的充电主机是否在线
xqbh: 小区编号，永远为 "SZDX"，苏州大学
zjgxsj: 格式为"YYYY-MM-DD hh:mm:ss"的字符串，表示该插座最后一次和后台通讯的时间，即“最近更新时间”
```
为了更人性化地向用户展示信息，还需要对以上数据做一定的处理，例如按照可用充电插座的数量进行排序、将充电棚编号和POS机编号重命名为对人类友好的别称、利用现有信息筛选已损坏的插座等等。其中筛选损坏插座的方法目前还停留在半自动的状态，通过后台查询功率变化的接口筛选掉那些后台不含有充电记录或充电时间短于五分钟但又显示在线的插座。每隔一段时间重新筛选一次，并保存在 `broken_sockets.json` 文件中（该文件的使用方法见[main.py#L152](https://github.com/Evlpsrfc/electromobile/blob/main/main.py#L152)）。

## 鸣谢

感谢后勤管理处的任凤然老师为我们介绍学校充电桩项目的建设历程和现况，以及向我们开放了后台账号。

感谢计算机学院2017级软件工程专业的曾连杰学长提供了外网映射。

感谢计算机学院学生科协提供的服务器支持。
